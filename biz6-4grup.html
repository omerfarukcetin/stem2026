<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>SUPRA COLLECT & DRIFT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root { --neon: #00ffff; --pink: #ff007f; --gold: #ffd700; }
        body, html { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Orbitron', sans-serif; }

        /* GİRİŞ EKRANI */
        #auth-overlay { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .cam-frame { width: 140px; height: 140px; border-radius: 50%; border: 2px solid var(--neon); overflow: hidden; position: relative; box-shadow: 0 0 20px var(--neon); }
        #video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); display: none; }
        .scan-line { position: absolute; width: 100%; height: 3px; background: var(--pink); top: 0; animation: scan 1.5s infinite linear; }
        @keyframes scan { 0% {top:0} 100% {top:100%} }

        #start-panel { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .btn-ignite { padding: 20px 50px; font-size: 1.8rem; background: var(--pink); color: white; border: none; cursor: pointer; border-radius: 50px; font-weight: bold; box-shadow: 0 0 30px var(--pink); }

        /* HUD */
        #hud { display: none; position: fixed; bottom: 30px; right: 40px; z-index: 100; text-align: right; pointer-events: none; }
        .speed-box { color: #111; text-shadow: 2px 2px 0px #fff; }
        .speedo { font-size: 5.5rem; font-weight: 900; line-height: 0.8; }
        .kmh-unit { font-size: 1.5rem; font-weight: bold; }
        
        #gear-box { margin-top: 10px; padding: 10px 20px; background: rgba(0,0,0,0.85); border-left: 5px solid var(--neon); color: white; display: inline-block; text-align: center; }
        #gearNum { font-size: 3.5rem; font-weight: 900; color: var(--pink); }

        /* PARA/SKOR GÖSTERGESİ (SOL ÜST) */
        #score-box { display: none; position: fixed; top: 30px; left: 30px; z-index: 100; background: rgba(0,0,0,0.8); padding: 15px 30px; border-radius: 10px; border: 2px solid var(--gold); color: var(--gold); font-weight: bold; font-size: 1.5rem; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
        #scoreNum { font-size: 2.5rem; }

        .controls-hint { position: fixed; bottom: 30px; left: 30px; color: white; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px; font-size: 0.8rem; pointer-events: none; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="cam-frame"><div class="scan-line"></div><video id="video" autoplay playsinline></video></div>
        <h2 style="margin-top: 20px; color: var(--neon); letter-spacing: 4px;">SÜRÜCÜ YETKİSİ</h2>
        <button onclick="initCamera()" id="btnCam" style="padding:10px 25px; cursor:pointer; background:var(--neon); border:none; border-radius:5px; font-weight:bold; margin-top: 20px; font-family: 'Orbitron';">SİSTEMİ AÇ</button>
        <div id="pw-box" style="display: none; margin-top: 20px;">
            <input type="password" id="pw" placeholder="VİTES ŞİFRESİ" style="padding:12px; background:#111; border:1px solid var(--pink); color:white; text-align:center; border-radius:8px; font-family: 'Orbitron';">
        </div>
    </div>

    <div id="start-panel">
        <h1 style="color: var(--neon); letter-spacing: 5px;">MANUEL MOD & PARA AVI</h1>
        <button class="btn-ignite" onclick="launchGame()">GAZLA</button>
        <p style="margin-top: 20px; color: #888;">E/Q: VİTES | SPACE: DRİFT | SEMBOLLERİ TOPLA!</p>
    </div>

    <div id="score-box">CASH: $<span id="scoreNum">0</span></div>

    <div id="hud">
        <div class="speed-box"><span class="speedo" id="kmh">0</span> <span class="kmh-unit">KM/H</span></div>
        <div id="gear-box"><span class="gear-label">GEAR</span><br><span id="gearNum">1</span></div>
    </div>

    <div id="controls-hint" style="display:none;" class="controls-hint">
        W: GAZ | S: FREN | A-D: DİREKSİYON<br>
        <b>E: VİTES ARTIR (+)</b><br>
        <b>Q: VİTES DÜŞÜR (-)</b><br>
        SPACE: PRO-DRIFT
    </div>

    <script>
        // 1. GİRİŞ SİSTEMİ
        async function initCamera() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('video').srcObject = s;
                document.getElementById('video').style.display = "block";
                document.getElementById('btnCam').style.display = "none";
                setTimeout(() => { document.getElementById('pw-box').style.display = "block"; }, 1000);
            } catch (e) { alert("Kamera gerekli."); }
        }
        document.getElementById('pw').addEventListener('input', (e) => {
            if(e.target.value.length >= 6) {
                document.getElementById('auth-overlay').style.display = "none";
                document.getElementById('start-panel').style.display = "flex";
            }
        });

        // 2. 3D DÜNYA DEĞİŞKENLERİ
        let scene, camera, renderer, supra, wheelL, wheelR;
        let coins = []; let score = 0; // Para sistemi için

        // Vites Limitleri
        const gearLimits = { "1": 1.0, "2": 1.5, "3": 2.0, "4": 3.0, "5": 3.5, "R": 4.0 };
        const gearOrder = ["1", "2", "3", "4", "5", "R"];
        let car = {
            speed: 0, angle: 0, velocity: new THREE.Vector2(0, 0),
            accel: 0.007, decel: 0.985, currentGearIndex: 0, steering: 0.04
        };
        const keys = { w:0, s:0, a:0, d:0, space:0 };
        let skidMarks = [];

        function launchGame() {
            document.getElementById('start-panel').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            document.getElementById('controls-hint').style.display = 'block';
            document.getElementById('score-box').style.display = 'block';
            init3D();
        }

        // --- SEMBOL DOKULARI OLUŞTURMA (CANVAS İLE) ---
        function createSymbolTexture(symbol, color) {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = color;
            ctx.shadowColor = color; ctx.shadowBlur = 20; // Neon parlama efekti
            ctx.font = 'bold 100px monospace';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(symbol, 64, 64);
            return new THREE.CanvasTexture(canvas);
        }

        function init3D() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB); 
            scene.fog = new THREE.Fog(0x87CEEB, 400, 3500);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 50000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(100, 200, 100);
            scene.add(sun);

            // --- PİST DÜZELTME (KAPKARANLIK VE DÜZ) ---
            const grass = new THREE.Mesh(new THREE.PlaneGeometry(50000, 50000), new THREE.MeshPhongMaterial({color: 0x27ae60}));
            grass.rotation.x = -Math.PI/2; scene.add(grass);

            // Pisti zeminden biraz daha yükseğe (0.2) koydum ki çimenle karışmasın.
            // Rengi tam mat siyah (0x050505) yaptım.
            const trackMat = new THREE.MeshPhongMaterial({color: 0x050505, shininess: 0});
            const track = new THREE.Mesh(new THREE.PlaneGeometry(110, 50000), trackMat);
            track.rotation.x = -Math.PI/2; 
            track.position.y = 0.2; // Çimenlerin üstünde kalması için yükseltildi
            scene.add(track);

            // Bordürler
            for(let i=0; i<2500; i++) {
                let z = (i*20)-25000;
                let curb = new THREE.Mesh(new THREE.BoxGeometry(6, 0.7, 10), new THREE.MeshPhongMaterial({color: i%2==0?0xffffff:0xff0000}));
                curb.position.set(-58, 0.35, z); scene.add(curb);
                let curbR = curb.clone(); curbR.position.x = 58; scene.add(curbR);
            }

            // --- SEMBOLLERİ (PARA) OLUŞTURMA ---
            const texAt = createSymbolTexture('@', '#00ffff'); // Mavi @
            const texExcl = createSymbolTexture('!', '#ff007f'); // Pembe !
            const coinGeo = new THREE.PlaneGeometry(4, 4);

            for(let i=0; i<400; i++) { // 400 adet sembol
                let isAt = Math.random() > 0.5;
                let mat = new THREE.MeshBasicMaterial({ map: isAt ? texAt : texExcl, transparent: true, side: THREE.DoubleSide });
                let coin = new THREE.Mesh(coinGeo, mat);
                
                // Rastgele konum (Pistte ve çimende)
                let posX = (Math.random() * 180) - 90; 
                let posZ = (Math.random() * 40000) - 20000;
                
                coin.position.set(posX, 2.5, posZ); // Yerden yüksekte süzülsün
                
                coins.push(coin);
                scene.add(coin);
            }

            // ARABA
            supra = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(2.6, 0.8, 5.5), new THREE.MeshPhongMaterial({color: 0xcc0000}));
            const cabin = new THREE.Mesh(new THREE.BoxGeometry(1.9, 0.7, 2.7), new THREE.MeshPhongMaterial({color: 0x111111}));
            cabin.position.set(0, 0.75, -0.4);
            const wing = new THREE.Mesh(new THREE.BoxGeometry(3.2, 0.1, 1.2), new THREE.MeshPhongMaterial({color: 0xcc0000}));
            wing.position.set(0, 1.4, -2.5);
            wheelL = new THREE.Object3D(); wheelL.position.set(-1.1, -0.4, -2.1); supra.add(wheelL);
            wheelR = new THREE.Object3D(); wheelR.position.set(1.1, -0.4, -2.1); supra.add(wheelR);
            supra.add(body, cabin, wing);
            supra.position.y = 0.6;
            scene.add(supra);

            // KONTROLLER
            window.addEventListener('keydown', e => {
                if(e.code==='KeyW') keys.w=1; if(e.code==='KeyS') keys.s=1;
                if(e.code==='KeyA') keys.a=1; if(e.code==='KeyD') keys.d=1;
                if(e.code==='Space') keys.space=1;
                if(e.code==='KeyE' && car.currentGearIndex < gearOrder.length - 1) car.currentGearIndex++;
                if(e.code==='KeyQ' && car.currentGearIndex > 0) car.currentGearIndex--;
            });
            window.addEventListener('keyup', e => {
                if(e.code==='KeyW') keys.w=0; if(e.code==='KeyS') keys.s=0;
                if(e.code==='KeyA') keys.a=0; if(e.code==='KeyD') keys.d=0; if(e.code==='Space') keys.space=0;
            });

            animate();
        }

        function createSkid(pos) {
            const mark = new THREE.Mesh(new THREE.PlaneGeometry(1.0, 2.5), new THREE.MeshBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.5 }));
            mark.position.copy(pos); mark.position.y = 0.25; // Pistin hemen üstünde
            mark.rotation.x = -Math.PI/2; mark.rotation.z = supra.rotation.y;
            scene.add(mark); skidMarks.push(mark);
            if(skidMarks.length > 800) { let old = skidMarks.shift(); scene.remove(old); }
        }

        function animate() {
            requestAnimationFrame(animate);
            let currentGearName = gearOrder[car.currentGearIndex];
            let maxSpeedForGear = gearLimits[currentGearName];

            if (keys.w) { car.speed < maxSpeedForGear ? car.speed += car.accel : car.speed *= 0.995; } 
            else if (keys.s) { car.speed -= car.accel * 3; } 
            else { car.speed *= car.decel; }
            if (car.speed > maxSpeedForGear) car.speed *= 0.98;
            if (car.speed < -0.4) car.speed = -0.4;

            let driftActive = keys.space && Math.abs(car.speed) > 0.4;
            let steerPower = car.steering * (driftActive ? 2.4 : 1.15);
            if (Math.abs(car.speed) > 0.05) {
                if (keys.a) car.angle += steerPower; if (keys.d) car.angle -= steerPower;
            }
            let targetX = Math.sin(car.angle) * car.speed; let targetZ = Math.cos(car.angle) * car.speed;
            let slip = driftActive ? 0.04 : 0.2;
            car.velocity.x += (targetX - car.velocity.x) * slip; car.velocity.y += (targetZ - car.velocity.y) * slip;
            supra.rotation.y = car.angle; supra.position.x += car.velocity.x; supra.position.z += car.velocity.y;

            if (driftActive) {
                let pL = new THREE.Vector3(); wheelL.getWorldPosition(pL); createSkid(pL);
                let pR = new THREE.Vector3(); wheelR.getWorldPosition(pR); createSkid(pR);
            }

            // --- PARA TOPLAMA MANTIĞI ---
            const carPos = supra.position.clone();
            for(let i = coins.length - 1; i >= 0; i--) {
                let coin = coins[i];
                if(carPos.distanceTo(coin.position) < 5) {
                    scene.remove(coin); // Sahneden sil
                    coins.splice(i, 1); // Listeden sil
                    score += 100; // Parayı artır
                    document.getElementById('scoreNum').innerText = score;
                }
                coin.rotation.y += 0.02;
            }

            camera.position.x = supra.position.x - Math.sin(car.angle) * 18;
            camera.position.z = supra.position.z - Math.cos(car.angle) * 18;
            camera.position.y = 8; camera.lookAt(supra.position.x, supra.position.y + 1, supra.position.z);

            document.getElementById('kmh').innerText = Math.floor(Math.abs(car.speed * 100));
            document.getElementById('gearNum').innerText = currentGearName;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>